<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html>
 	<head>
 		<meta http-equiv="Content-type" content="text/html;charset=UTF-8">
 		<title></title>
 		<script type="text/javascript" src="deps/1.7.2/jquery.min.js"></script>
 		<script type="text/javascript" src="deps/autosize/jquery.autosize-min.js"></script>
 		<script type="text/javascript" src="deps/strftime.js"></script>
 		<script type="text/javascript" src="deps/sprintf-0.7-beta1.js"></script>	
 		<script type="text/javascript" src="deps/date.js"></script>
	 	<style>
	 	body {
	 		font-size: 100%;
	 	}
 		input.try {
			margin-top: 1px;
			font-size: 100%;
			background: white none repeat scroll 0 0;
			border-color: black;
		}
		input[type='button'] {
			display:none;
		}
		input[type='text'] {
			font-size: 100%;
    		border:1px solid blue;
   			width:100%;
    		margin:5px 0;
    		padding:3px;
		}
 		textarea {
			margin-top: 1px;
			font-size: 100%;
			width:100%;
			height:1.5em;
			white-space: nowrap;
			background: white none repeat scroll 0 0;
		}
		textarea.try
		{
		    border:1px solid yellow;
		}
		textarea.enter
		{
		    border:1px solid blue	;
		}
		.boxsizingBorder {
		    -webkit-box-sizing: border-box;
		    -moz-box-sizing: border-box;
			box-sizing: border-box;
		}
		</style>
 	</head>
 	<script>
 	
	 	 var Start   = '2012-10-01';
	 	 var Stop    = '2012-10-10';
	 	 var Cadence = '';
	
	 	 var Catalog = {Name:"USGS Real Time Magnetometer Measurements",
	 	 				ID: "USGS/MAG/1M",
	 	 				Description: "USGS Real Time Magnetometer Measurements"};
	 	 var Dataset = [
	 	 				["BDT one-minute","BDT1m","bdtvmin","BDT","bdt","Boulder Test"],
	 	               	["BOU one-minute","BOU1m","bouvmin","BOU","bou","Boulder"],
						["BRT test one-minute","BRT1m","brtvmin","BRT","brt","Barrow Test"],
						["BRW one-minute","BRW1m","brwvmin","BRW","brw","Barrow"],
						["BSL one-minute","BSL1m","bslvmin","BSL","bsl","Stennis Space Center"],
						["CMO one-minute","CMO1m","cmovmin","CMO","cmo","College"],
						["DED one-minute","DED1m","dedvmin","DED","ded","Deadhorse"],
						["FRD one-minute","FRD1m","frdvmin","FRD","frd","Fredericksburg"],
						];
	 	 var Template           = "http://magweb.cr.usgs.gov/data/magnetometer/$4/OneMinute/$5%Y%m%dvmin.min";
	 	 var ColumnLabels       = ["Date","Time","DOY","$4H","$4D","$4Z","$4F"];
	 	 var ColumnLongnames    = ["Date","Time","DOY","$6 H","$6 D","$6 Z","$6 F"];
		 var ColumnUnits        = ["Date","Time","DOY","nT","nT","nT","nT"];
	 	 var ColumnGroupings    = ["none","none","none","$4_XYZ","$4_XYZ","$4_XYZ","none"];
	 	 var LineTemplate       = "%Y-%m-%d %h:%M:%s.%ss %j %.2f %.2f %.2f %.2f";
	 	 var LineRegex          = "^[0-9][0-9][0-9][0-9]";
	 	 var ColumnGroupnames   = {"$4_XYZ":"Flux-gate Magnetometer Data"};
	 	 var ColumnGrouptypes   = {"$4_XYZ":"Vector"};

		function expandtemplate(el,tmpstr,Dataset) {
			
			if (arguments.length == 1) {
				Dataset = $('#Dataset').val().split("\n");
				console.log(Dataset);
				tmpstr = $(el).prev().val();
				for (i = 0; i < Dataset.length;i++) {
					TemplateExpanded = expandtemplate(el,tmpstr,Dataset[i]);
					console.log(TemplateExpanded);
				}

				return TemplateExpanded;
			}

		    if (tmpstr instanceof Object) {
				tmpobj = {};
				for (var attr in tmpstr) {
					tmpobj[expandtemplate(el,attr,Dataset)] = expandtemplate(el,tmpstr[attr],Dataset);
				}
				return tmpobj;
		    }

			if (!tmpstr){return "";}
			
			var N = tmpstr.match(/\$/g).length; // Number of wildcards
			sDataset = Dataset.split(",");
			for (var i=0;i < N; i++) {
				tmpstr = tmpstr.replace(/\$([0-9])/,"'+sDataset[$1-1]+'");
			}
		 	tmpstr = "'" + tmpstr + "'";
		 	tmpstr = eval(tmpstr);
			$(el).nextAll('textarea').eq(0).val($(el).nextAll('textarea').eq(0).val()+tmpstr+"\n");

			if (!tmpstr.match("%")) {
				return tmpstr;
			}

			var START_ms   = new Date(Date.parse($('#Start').val()));
			var STOP_ms    = new Date(Date.parse($('#Stop').val()));
			var Ndays      = 1 + Math.round((STOP_ms.valueOf()-START_ms.valueOf())/(1000*24*60*60));
			var START_date = Date.parse(Start);

			var i = 0;
			var urls = new Array();
			var aurls = new Array();
			while (i < Ndays) {
				fname = START_date.strftime(tmpstr);
				urls[i] = fname;
				var aurl = "http://aurora.gmu.edu:8080/AutoplotServlet-20121220/SimpleServlet?url=";
				var aurl = aurl + encodeURIComponent("vap+dat:"+urls[i]+"?skipLines=25&time=field0&timeFormat=$Y-$m-$d+$H:$M:$S&column=field3&plot.title=field3");
				aurls[i] = aurl;
				console.log(aurl);
				START_date.addDays(1);
				i = i + 1;
			}
			$(el).nextAll('textarea').eq(1).val($(el).nextAll('textarea').eq(1).val()+urls+"\n\n");
			$(el).nextAll('textarea').eq(1).val($(el).nextAll('textarea').eq(1).val().replace(/,/g,"\n"));
			$(el).nextAll('textarea').eq(2).val($(el).nextAll('textarea').eq(2).val()+aurls+"\n\n");
			$(el).nextAll('textarea').eq(2).val($(el).nextAll('textarea').eq(2).val().replace(/,/g,"\n"));		

			$(el).nextAll('textarea').eq(0).scrollLeft(1000);
			$(el).nextAll('textarea').eq(1).scrollLeft(1000);
			$(el).nextAll('textarea').eq(2).scrollLeft(1000);
			 
			var template0 = '<dataset name="$1"><access serviceName="tss" urlPath="$2"/><access serviceName="ncml" urlPath="$2"/><timeCoverage><Start>$Start</Start><End>$Stop</End></timeCoverage></dataset>';
			var template = '';
			for (i=0;i < Dataset.length;i++) {
				template = template +
							template0.
								replace("$1",Dataset[i][0]).
								replace(/\$2/g,Dataset[i][1]).
								replace("$Start",Start).
								replace("$Stop",Stop);
			}
			template = '<catalog xmlns="http://www.unidata.ucar.edu/namespaces/thredds/InvCatalog/v1.0" xmlns:xlink="http://www.w3.org/1999/xlink" name="$CatalogName">' + template + '</catalog>'
			template = template.replace("$CatalogName",$('#CatalogName').val());
			$('#catalog').val('');
			$('#catalog').val(template);

			return urls;
		}
		
		function links() {
			//console.log($('#urls').val().split("\n\n")[0]);
			linkblocks = $('#urls').val().split("\n\n");
			console.log(linkblocks);
			$("#tryurls").html("");
			for (i = 0;i < linkblocks.length-1;i++) {
				var url = "http://datacache.org/dc/syncsubmit?source="+encodeURI(linkblocks[i]);
				console.log("url length: " + url.length);
				$("#tryurls").append("<a id='" +i + "' href='"+url+"'>"+i+"</a> ");
			}
			$("#links").show();		
		}
		function detectchange() {			
				
				var newval = "";
				$('.enter').each(function () {newval = newval + $(this).val()});
				if (detectchange.lastval && newval != detectchange.lastval) {
					console.log("Change detected:");// + detectchange.lastval + " | " + newval);
					$('input[type=button].try').click();
				} else {
					console.log("No change detected");
				}
				detectchange.lastval = newval;
				
			}

		$(document).ready(function(){
			$('#CatalogName').val(Catalog["Name"]);
			$('#CatalogID').val(Catalog["ID"]);
			$('#CatalogDescription').val(Catalog["Description"]);
			$('#Template').val(Template);
			$('#LineTemplate').val(LineTemplate);
			$('#LineRegex').val(LineRegex);
			$('#ColumnUnits').val(ColumnUnits);
			var tmp = JSON.stringify(Dataset).replace(/\],\[/g,"\n").replace("[[","").replace("]]","").replace(/\"/g,"");
			//console.log(tmp)
			$('#Dataset').text(tmp);
			//$('#Dataset').text(Dataset[0]+"\n"+Dataset[1]);
			$('#ColumnLabels').val(ColumnLabels);
			$('#ColumnLongnames').val(ColumnLongnames);

			$('#ColumnGroupings').val(ColumnGroupings);
			$('#ColumnGroupnames').val(JSON.stringify(ColumnGroupnames));
			$('#ColumnGrouptypes').val(JSON.stringify(ColumnGrouptypes));

			$('#Start').val(Start);
			$('#Stop').val(Stop);
			
			$('input[type=button].try').click(
				function () {
					$('textarea.try').val('');						
					$('input[type=button].try').each(function() {expandtemplate(this)});
					links();
					
				});

			$('textarea').autosize();
			
			$("textarea.try").mouseenter(function() {
				// Remove last newline.
				$(this).val($(this).val().replace(/^\s+|\s+$/g, ""));
				// Trigger autosize event.
				$(this).trigger("oninput");
			});
			$("textarea.try").mouseout(function() {
				$(this).height("1.5em");
			});

			setInterval(detectchange,500);
			$('input[type=button].try').click();				

		});
 	</script>
 	<body>
 	<form id="mainform" action="/" method="post">
 		<input type="submit" class="try" value="Submit">
		<br/>
		Catalog name
 		<br/>
 		<input class="enter" type="text" id="CatalogName"></input>
 		<br/>
		Catalog ID
 		<br/>
 		<input class="enter" type="text" id="CatalogID"></input>
 		<br/>
		Catalog description
 		<br/>
 		<input class="enter" type="text" id="CatalogDescription"></input>
 		<br/>
		Data line regular expression
 		<br/>
 		<input type="text" id="LineRegex"></input>
 		<br/>
		Data line template 			
 		<br/>
 		<input type="text" id="LineTemplate"></input>
 		<br/>
 		Column units
 		<br/>
 		<input type="text" id="ColumnUnits"></input>
 		<br/>
 		<hr/>
 		Dataset description, ID, other info
 		<br>
 		<textarea class="enter" id="Dataset"></textarea>
 		<br/>
 		Column labels
 		<br/>
 		<input type='text' id="ColumnLabels" class="enter"></input>
 		<input type="button" class="try" value="Expand">
 		<br/>
 		<textarea class="try"></textarea>
 		<br/>
 		Column description
 		<br/>
 		<input type="text" id="ColumnLongnames" class="enter"></input>
		<input type="button" class="try" value="Expand">
 		<br/>
 		<textarea class="try"></textarea>
 		<br/>
 		Column groupings
 		<br/>
 		<input type="text" id="ColumnGroupings" class="enter"></input>
		<input type="button" class="try" value="Expand">
 		<br/>
 		<textarea class="try"></textarea>
 		<br/>
 		Column group names
 		<br/>
 		<input type="text" id="ColumnGroupnames" class="enter"></input>
		<input type="button" class="try" value="Expand">
 		<br/>
 		<textarea class="try"></textarea>
 		<br/>
 		Column group types
 		<br/>
 		<input type='text' id="ColumnGrouptypes" class="enter"></input>
		<input type="button" class="try" value="Expand">
 		<br/>
 		<textarea class="try"></textarea>
 		<br/>
 		<hr/>
 		<br/>
 		Start date(s)
 		<br/>
 		<input type="text" id="Start" class="enter"></input>
 		<br/>
 		Stop date(s)
 		<br/>
 		<input type="text" id="Stop" class="enter"></input>
 		<br/>
 		URL template
 		<br/>
 		<input type="text" id="Template" class="enter"></input>
 		<input type="button" class="try" value="Expand">
 		<br/>
 		<textarea class="try"></textarea>
 		<br/>
 		<textarea id="urls" class="try"></textarea>
 		<br/>
 		<div class="links" style="display:none">Try URLs: <span id="tryurls" value="Try URLs"></span></div>
 		<br/>
 		<textarea id="aurls" class="try"></textarea>
 		<br/>
 		<div id="links" style="display:none">Try URLs: <span id="tryaurls" value="Try URLs"></span></div>
 		<br/>
		catalog.thredds:
		<br/>
	 	<textarea class="try" id="catalog"></textarea>
		<br/>
		<input type="submit" class="try" value="Submit">
 	</form>
 	</body>
 </html>