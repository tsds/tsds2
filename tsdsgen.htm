<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
 <html>
 	<head>
 		<meta http-equiv="Content-type" content="text/html;charset=UTF-8">
 		<title>TSDS Generator</title>
 		<link rel="stylesheet" type="text/css" href="asset/main.css">
 		<script type="text/javascript" src="deps/1.7.2/jquery.min.js"></script>
 		<script type="text/javascript" src="deps/autosize/jquery.autosize-min.js"></script>
 		<script type="text/javascript" src="deps/strftime.js"></script>
 		<script type="text/javascript" src="deps/sprintf-0.7-beta1.js"></script>	
 		<script type="text/javascript" src="deps/date.js"></script>
 		<script type="text/javascript" src="tsdsgen-default.js"></script>
 	</head>
 	<script>
		function expandtemplate(el,tmpstr,Dataset) {
			
			if (arguments.length == 1) {
				Dataset = $('#Dataset').val().split("\n");
				console.log(Dataset);
				tmpstr = $(el).prev().val();
				for (i = 0; i < Dataset.length;i++) {
					TemplateExpanded = expandtemplate(el,tmpstr,Dataset[i]);
					console.log(TemplateExpanded);
				}

				return TemplateExpanded;
			}

		    if (tmpstr instanceof Object) {
				tmpobj = {};
				for (var attr in tmpstr) {
					tmpobj[expandtemplate(el,attr,Dataset)] = expandtemplate(el,tmpstr[attr],Dataset);
				}
				return tmpobj;
		    }

			if (!tmpstr){return "";}
			
			var N = tmpstr.match(/\$/g).length; // Number of wildcards
			sDataset = Dataset.split(",");
			for (var i=0;i < N; i++) {
				tmpstr = tmpstr.replace(/\$([0-9])/,"'+sDataset[$1-1]+'");
			}
		 	tmpstr = "'" + tmpstr + "'";
		 	tmpstr = eval(tmpstr);
			$(el).nextAll('textarea').eq(0).val($(el).nextAll('textarea').eq(0).val()+tmpstr+"\n");

			if (!tmpstr.match("%")) {
				return tmpstr;
			}

			var START_ms   = new Date(Date.parse($('#Start').val()));
			var STOP_ms    = new Date(Date.parse($('#Stop').val()));
			var Ndays      = 1 + Math.round((STOP_ms.valueOf()-START_ms.valueOf())/(1000*24*60*60));
			var START_date = Date.parse(Start);

			var i = 0;
			var urls = new Array();
			var aurls = new Array();
			while (i < Ndays) {
				fname = START_date.strftime(tmpstr);
				urls[i] = fname;
				var aurl = "http://aurora.gmu.edu:8080/AutoplotServlet-20121220/SimpleServlet?url=";
				var aurl = aurl + encodeURIComponent("vap+dat:"+urls[i]+"?skipLines=25&time=field0&timeFormat=$Y-$m-$d+$H:$M:$S&column=field3&plot.title=field3");
				aurls[i] = aurl;
				console.log(aurl);
				START_date.addDays(1);
				i = i + 1;
			}
			$('#urls').val($('#urls').val()+urls+"\n\n");
			$('#urls').val($('#urls').val().replace(/,/g,"\n"));
			$('#urls').scrollLeft(1000);

			$('#aurls').val($('#aurls').val()+aurls+"\n");
			$('#aurls').val($('#aurls').val().replace(/,/g,"\n"));
			$('#aurls').scrollLeft(1000);
			 
			var template0 = '<dataset name="$1"><access serviceName="tss" urlPath="$2"/><access serviceName="ncml" urlPath="$2"/><timeCoverage><Start>$Start</Start><End>$Stop</End></timeCoverage></dataset>';
			var template = '';
			for (i=0;i < Dataset.length;i++) {
				template = template +
							template0.
								replace("$1",Dataset[i][0]).
								replace(/\$2/g,Dataset[i][1]).
								replace("$Start",Start).
								replace("$Stop",Stop);
			}
			template = '<catalog xmlns="http://www.unidata.ucar.edu/namespaces/thredds/InvCatalog/v1.0" xmlns:xlink="http://www.w3.org/1999/xlink" name="$CatalogName">' + template + '</catalog>'
			template = template.replace("$CatalogName",$('#CatalogName').val());
			$('#catalog').val('');
			$('#catalog').val(template);

			return urls;
		}
		
		function links() {
			//console.log($('#urls').val().split("\n\n")[0]);
			linkblocks = $('#urls').val().split("\n\n");
			console.log(linkblocks);
			$("#tryurls").html("");
			for (i = 0;i < linkblocks.length-1;i++) {
				var url = "http://datacache.org/dc/syncsubmit?source="+encodeURI(linkblocks[i]);
				console.log("url length: " + url.length);
				$("#tryurls").append("<a id='" +i + "' href='"+url+"'>"+i+"</a> ");
			}
			$("#links").show();		
		}
		function detectchange() {			
				
				var newval = "";
				$('.enter').each(function () {newval = newval + $(this).val()});
				if (detectchange.lastval && newval != detectchange.lastval) {
					console.log("Change detected:");// + detectchange.lastval + " | " + newval);
					$('input[type=button].try').click();
				} else {
					console.log("No change detected");
				}
				detectchange.lastval = newval;
				
		}

		$(document).ready(function(){
			$('#CatalogName').val(CatalogDescription["Name"]);
			$('#CatalogID').val(CatalogDescription["ID"]);
			$('#CatalogDescription').val(CatalogDescription["Description"]);
			$('#Template').val(Template);
			$('#LineTemplate').val(LineTemplate);
			$('#LineRegex').val(LineRegex);
			$('#ColumnUnits').val(ColumnUnits);
			var tmp = JSON.stringify(DatasetDescription).replace(/\],\[/g,"\n").replace("[[","").replace("]]","").replace(/\"/g,"");
			//console.log(tmp)
			$('#Dataset').text(tmp);
			//$('#Dataset').text(Dataset[0]+"\n"+Dataset[1]);
			$('#ColumnLabels').val(JSON.stringify(ColumnLabels));
			$('#ColumnLongnames').val(JSON.stringify(ColumnLongnames));
			$('#ColumnGroupings').val(JSON.stringify(ColumnGroupings));
			$('#ColumnGroupnames').val(JSON.stringify(ColumnGroupnames));
			$('#ColumnGrouptypes').val(JSON.stringify(ColumnGrouptypes));

			$('#Start').val(Start);
			$('#Stop').val(Stop);
			
			$('input[type=button].try').click(
				function () {
					$('textarea.try').val('');						
					$('input[type=button].try').each(function() {expandtemplate(this)});
					links();
					
				});

			$('textarea').autosize();
			
			$("textarea.try").mouseenter(function() {
				// Remove last newline.
				$(this).val($(this).val().replace(/^\s+|\s+$/g, ""));
				// Trigger autosize event.
				$(this).trigger("oninput");
			});
			$("textarea.try").mouseout(function() {
				//$(this).height("1.5em");
			});

			setInterval(detectchange,500);
			$('input[type=button].try').click();				

		});

		function tryajax(el) {
			var url = "http://datacache.org/dc/syncsubmit?source=";
			url     = url + encodeURI($($(el).prevAll('textarea')[0]).val());
			window.location.href = url;
		}
		</script>
 	<body>
 	<div id="submiturl"></div>
 	<div style="width:50%">
 	<form id="form" action="/" method="post">
 		<input type="submit" class="try" value="Submit">
		<br/>
		* Catalog Name
 		<br/>
 		<input class="enter" type="text" id="CatalogName"></input>
 		<br/>
		* Catalog ID
 		<br/>
 		<input class="enter" type="text" id="CatalogID"></input>
 		<br/>
		Catalog Description (If not specified, Catalog Name is used.)
 		<br/>
 		<input class="enter" type="text" id="CatalogDescription"></input>
 		<br/>
 		* Column units
 		<br/>
 		<input type="text" id="ColumnUnits"></input>
 		<br/>
 		<br/>
 		<hr/>
		<br/>
 		Dataset description, [ID, other info].  (If not specified, ID is generated based on Dataset Description.)
 		<br>
 		<textarea class="enter" id="Dataset"></textarea>
 		<br/>
 		Column labels
 		<br/>
 		<input type='text' id="ColumnLabels" class="enter"></input>
 		<input type="button" class="try" value="Expand">
 		<br/>
 		<textarea class="try"></textarea>
 		<br/>
 		Column description
 		<br/>
 		<input type="text" id="ColumnLongnames" class="enter"></input>
		<input type="button" class="try" value="Expand">
 		<br/>
 		<textarea class="try"></textarea>
 		<br/>
 		Column groupings
 		<br/>
 		<input type="text" id="ColumnGroupings" class="enter"></input>
		<input type="button" class="try" value="Expand">
 		<br/>
 		<textarea class="try"></textarea>
 		<br/>
 		Column group names
 		<br/>
 		<input type="text" id="ColumnGroupnames" class="enter"></input>
		<input type="button" class="try" value="Expand">
 		<br/>
 		<textarea class="try"></textarea>
 		<br/>
 		Column group types
 		<br/>
 		<input type='text' id="ColumnGrouptypes" class="enter"></input>
		<input type="button" class="try" value="Expand">
 		<br/>
 		<textarea class="try"></textarea>
 		<br/>
		<br/>
 		<hr/>
 		<br/>
 		* URL template
 		<br/>
 		<input type="text" id="Template" class="enter"></input>
 		<input type="button" class="try" value="Expand">
 		<br/>
 		<textarea class="try"></textarea>
 		<br/>
 		<br/>
		Data line regular expression <input type="button" class="guessajax" value="Guess">
 		<br/>
 		<input type="text" id="LineRegex"></input>
 		<br/>
		Data Line Template <input type="button" class="guessajax" value="Guess">
 		<br/>
  		<input type="text" id="LineTemplate"></input>
 		<br/>
 		<br/>
 		Start date min
 		<br/>
 		<input type="text" id="Start" class="enter"></input>
 		<br/>
 		<textarea class="try"></textarea>
 		<br/>
 		<br/> 		
 		Stop date max
 		<br/>
 		<input type="text" id="Stop" class="enter"></input>
 		<br/>
 		<textarea class="try"></textarea>
 		<br/> 		
 		<br/>
 		Data urls
  		<textarea id="urls" class="try"></textarea>
 		<br/>
 		<br/>
		Plot urls
 		<textarea id="aurls" class="try"></textarea>
		<br/>
		<br/>
		catalog.thredds:
		<br/>
	 	<textarea class="try" id="catalog"></textarea>
		<br/>
		<input type="submit" class="try" value="Submit">
 	</form>
 	</div>
 	</body>
 </html>